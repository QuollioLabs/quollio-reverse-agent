AWSTemplateFormatVersion: 2010-09-09
Description: >-
  Quollio Reverse Agent for BigQuery

Parameters:
  # AWS Batchジョブをスケジュール実行しない場合は　'DISABLED' に変更
  EnableSchedule:
    Type: String
    Description: Enable/Disable schedule of AWS Batch job. Default is 'ENABLED'
    Default: ENABLED
    AllowedValues:
      - "ENABLED"
      - "DISABLED"
  # AWS Batchジョブを起動するcron形式スケジュール。デフォルト値は日本時間の深夜0時に日次で起動
  EventSchedule:
    Type: String
    Description: Schedule for executing AWS Batch. Default schedule is daily at 0:00 in JST
    Default: cron(0 15 * * ? *)
  #  ECRリポジトリの存在するのAWSアカウントID
  ECRRepositoryAccountId:
    Type: Number
    Description: <DO NOT MODIFY> AWS account ID of ECR Repository
    NoEcho: true
  # (変更不可) ECRリポジトリのAWSリージョン
  ECRRepositoryRegion:
    Type: String
    Description: <DO NOT MODIFY> AWS region of ECR repository
    Default: ap-northeast-1
    AllowedValues:
      - ap-northeast-1
  # (変更不要) 作成するAWSリソース名につく接頭辞
  ResourcePrefix:
    Type: String
    Description: <NO NEED TO MODIFY> Prefix of AWS resources created by this stack
    Default: quollio-metadata-agent
  # (必須) AWS BatchのジョブにパブリックIPを割り当てるかどうか。プライベートサブネットを使用している場合は 'DISABLED' に変更
  AssignPublicIp:
    Type: String
    Description: <Required> Assign Public IP to AWS Batch job or not. If the subnet is private, AssignPublicIp is supposed to be 'DISABLED'
    Default: ENABLED
    AllowedValues:
      - "ENABLED"
      - "DISABLED"
  # (任意) 同種のデータソースで2つ以上Metadata Agentを構築する場合に、パラメータストア側で使用する接頭辞
  ParameterStorePrefix:
    Type: String
    Description: This prefix has to be unique when hosting more than two Metadata Agent for homogeneous data sources
    Default: "default"
  # (任意) CloudWatch LogsのRetention Period
  LogsRetentionInDays:
    Type: Number
    Description: Retention period of CloudWatch Logs
    Default: 30

Resources:
  # ECRのRead権限やInfra stackで作成したIAM Policyを付与するIAM Role
  BatchTaskExecutionRole:
    Type: 'AWS::IAM::Role'
    Properties:
      RoleName: !Sub ${AWS::StackName}-batch-task-execution-role
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Sid: ''
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: 'sts:AssumeRole'
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/service-role/AWSBatchServiceRole'
        - 'arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly'
        - !Sub 'arn:aws:iam::${AWS::AccountId}:policy/${ResourcePrefix}-cross-account-access'
        - !Sub 'arn:aws:iam::${AWS::AccountId}:policy/${ResourcePrefix}-s3-process-limited-bucket-access'
        - !Sub 'arn:aws:iam::${AWS::AccountId}:policy/${ResourcePrefix}-secrets-store-limited-access-policy'
  IamInstanceProfile:
    Type: 'AWS::IAM::InstanceProfile'
    Properties:
      InstanceProfileName: !Sub ${AWS::StackName}-batch-task-execution-role-iam-profile
      Roles:
        - !Ref BatchTaskExecutionRole

  # AWS Batchのジョブ定義
  JobDefinition:
    Type: 'AWS::Batch::JobDefinition'
    Properties:
      Type: container
      PropagateTags: true
      JobDefinitionName: !Sub ${AWS::StackName}
      ContainerProperties:
        Image: !Join ['.', [!Ref ECRRepositoryAccountId, 'dkr.ecr', !Ref ECRRepositoryRegion, 'amazonaws.com/quollio-reverse-agent-universal:latest']]
        FargatePlatformConfiguration:
          PlatformVersion: LATEST
        ResourceRequirements:
          - Value: 1
            Type: VCPU
          - Value: 2048
            Type: MEMORY
        JobRoleArn: !GetAtt 'BatchTaskExecutionRole.Arn'
        ExecutionRoleArn: !GetAtt 'BatchTaskExecutionRole.Arn'
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref BatchLogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: !Sub ${AWS::StackName}
        NetworkConfiguration:
          AssignPublicIp: !Sub ${AssignPublicIp}
        Environment:
          - Name: SYSTEM_NAME
            Value: bigquery
        Secrets:
          - Name: "GOOGLE_CLOUD_SERVICE_ACCOUNT_CREDENTIALS"
            ValueFrom: !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/quollio/${ParameterStorePrefix}/google_cloud_service_account_credentials"
          - Name: "QDC_BASE_URL"
            ValueFrom: !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/quollio/${ParameterStorePrefix}/qdc_base_url"
          - Name: "QDC_CLIENT_ID"
            ValueFrom: !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/quollio/${ParameterStorePrefix}/qdc_client_id"
          - Name: "QDC_CLIENT_SECRET"
            ValueFrom: !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/quollio/${ParameterStorePrefix}/qdc_client_secret"
      PlatformCapabilities:
        - FARGATE
      RetryStrategy:
        Attempts: 1
      Tags:
        Service: Batch
        Name: QuollioReverseAgent
        Expected: MergeTag
  JobQueue:
    Type: 'AWS::Batch::JobQueue'
    Properties:
      JobQueueName: !Sub "${AWS::StackName}"
      Priority: 1
      ComputeEnvironmentOrder:
        - Order: 1
          ComputeEnvironment: !Sub 'arn:aws:batch:${AWS::Region}:${AWS::AccountId}:compute-environment/${ResourcePrefix}-compute-environment'

  # AWS Batchが出力するCloudWatch Logs Group
  BatchLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub ${AWS::StackName}
      RetentionInDays: !Ref LogsRetentionInDays
  # AWS Batchを定期実行するEventBridgeの定義
  EventRule:
    Type: AWS::Events::Rule
    Properties:
      Name: !Sub ${AWS::StackName}
      Description: Event to trigger AWS Batch of Quollio Intelligence Agent
      RoleArn: !Sub 'arn:aws:iam::${AWS::AccountId}:role/${ResourcePrefix}-batch-service-role'
      ScheduleExpression: !Ref EventSchedule
      State: !Sub ${EnableSchedule}
      Targets:
        - Arn: !Ref JobQueue
          BatchParameters:
            JobDefinition: !Ref JobDefinition
            JobName: !Sub ${AWS::StackName}
            RetryStrategy:
              Attempts: 5
          Id: !Sub ${AWS::StackName}
          RoleArn: !Sub 'arn:aws:iam::${AWS::AccountId}:role/${ResourcePrefix}-batch-service-role'
